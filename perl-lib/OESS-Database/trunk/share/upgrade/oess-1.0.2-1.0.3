#!/usr/bin/perl
#-------------------------------------------------------------------
#----- OESS 1.02 - 1.0.3 upgrade module                         
#-----                                                               
#----- Copyright(C) 2010 The Trustees of Indiana University          
#--------------------------------------------------------------------
#----- $HeadURL: $                                                   
#----- $Id: $                                                        
#-----                                                               
#----- This is run when upgrading the database from     
#----- version 1.0.2 to version 1.0.3                                
#-------------------------------------------------------------------- 

use strict;
use warnings;
use Term::Prompt;
use Term::ReadLine;
use Term::UI;
use Term::Screen;

my $prev_version = "1.0.2";
my $version = "1.0.3";

sub main{
    my $term = Term::ReadLine->new('brand');

    print "*******************************************************************\n";
    print "*********             OESS DB UPGRADE           ************\n";
    print "*******************************************************************\n";
    print "********* This will upgrade from $prev_version to $version **********\n";
    print "********* of the OESS DB any other version will not work ************\n";
    
    
    my $bool = $term->ask_yn(
	prompt => 'Do you wish to continue?',
	default => 'y',
	);
    
    if(!$bool){
	print "User Abort!!\n";
	exit;
    }
    
    my $dbq = OESS::Database->new();
    my $current_version = $dbq->get_oess_schema_version();    
    
    if(@$current_version[0] eq ''){
	$dbq->{'dbh'}->begin_work();
	upgrade($dbq->{'dbh'});
	$dbq->{'dbh'}->commit();
    }else{
	print "Wrong version of OESS DB\n";
	print "This script only upgrades from version $prev_version to $version\n";
	exit;
    }
    
    print STDERR "Upgrade Successful!!\n";
    
}


sub upgrade{
    my $dbh = shift;
    my $term = shift;

    ####################################
    #
    # Ask for any new parameters here
    #
    ####################################
    
    
    #################################### 
    #
    # All Changes should happen in here
    #
    ####################################
   
    #first lets add the versioning component
    my $str = "create table oess_version (version varchar(32))";
    my $sth = $dbh->prepare($str);
    $sth->execute();
    
    $str = "alter table node add 0 varchar(255)";
    $sth = $dbh->prepare($str);
    $sth->execute();
    
    ####################################
    #
    # End all changes
    #
    #####################################
    
    #ok done with the rest of the upgrade update our version
    $str = "insert into oess_version (version) VALUES ('$version')";
    $sth = $dbh->prepare($str) or die "Unable to prepare version update \n";
    $sth->execute() or die "Unable to update version\n";
}

main();
