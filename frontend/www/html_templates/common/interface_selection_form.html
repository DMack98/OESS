<template id="template-interface-selection-form">
  <form class="interface-selection-form">
    <div class="form-group">
      <label class="control-label">Interface</label>
      <select class="form-control interface-selector"></select>
    </div>
    <div class="form-group">
      <label class="control-label">VLAN</label>
      <select class="form-control vlan-selector"></select>
    </div>
    <div class="form-group">
      <label class="control-label">Max Bandwidth (Mb/s)</label>
      <input class="form-control endpoint-bandwidth"
             placeholder="Unlimited"
             type="number" min="10" max="100000"/>
    </div>
    <div class="form-group">
      <input id="endpoint-index" class="form-control" type="hidden">
    </div>

    <button class="btn btn-success add-endpoint-submit" type="button">Add Endpoint</button>
    <button class="btn btn-danger add-endpoint-cancel" type="button">Cancel</button>
  </form>
</template>

<script>
 class InterfaceSelectionForm {
   template = document.querySelector('#template-interface-selection-form');

   onCancel = function(e) { console.log(e); }
   onSubmit = function(e) { console.log(e); }

   constructor(parent) {
     this.parent = parent;
     this.parent.appendChild(document.importNode(this.template.content, true));

     this.onCancel = this.onCancel.bind(this);
     this.onSubmit = this.onSubmit.bind(this);

     this.loadInterfaces = this.loadInterfaces.bind(this);
     this.loadVlans = this.loadVlans.bind(this);

     this.parent.querySelector('.add-endpoint-submit').addEventListener('click', function(e) {
       let interfaceSelector = this.parent.querySelector('.interface-selector');
       let vlanSelector = this.parent.querySelector('.vlan-selector');

       let endpoint = {
         bandwidth:        this.parent.querySelector('.endpoint-bandwidth').value,
         interface:        interfaceSelector.options[interfaceSelector.selectedIndex].dataset.name,
         interface_id:     interfaceSelector.options[interfaceSelector.selectedIndex].value,
         description:      interfaceSelector.options[interfaceSelector.selectedIndex].dataset.description,
         node:             interfaceSelector.options[interfaceSelector.selectedIndex].dataset.node,
         entity:           null, // entity,
         entity_id:        null, // entity_id,
         peerings:         [],
         cloud_account_id: '',
         tag:              vlanSelector.options[vlanSelector.selectedIndex].value
       };

       this.onSubmit(endpoint);
     }.bind(this));

     this.parent.querySelector('.add-endpoint-cancel').addEventListener('click', function(e) {
       this.onCancel(e);
     }.bind(this));
   }

   async loadVlans(id) {
     let interfaceSelector = this.parent.querySelector('.interface-selector');
     let interfaceId = interfaceSelector.options[interfaceSelector.selectedIndex].value;

     let vlanSelector = this.parent.querySelector('.vlan-selector');

     let vlans = await getAvailableVLANs(session.data.workgroup_id, interfaceId);
     let vlan = (vlans.length === 0) ? -1 : vlans[0];
     if (Number.isInteger(id)) {
       // If not an event the vlan was specified by the user.
       vlan = id;
     }

     vlans.forEach((v) => {
       let o = document.createElement('option');
       o.innerText = `${v}`;
       o.setAttribute('value', v);

       if (v == vlan) {
         o.setAttribute('selected', true);
       }

       vlanSelector.appendChild(o);
     });
   }

   async loadInterfaces(id) {
     let interfaceSelector = this.parent.querySelector('.interface-selector');

     let interfaces = await getInterfacesByWorkgroup(session.data.workgroup_id);
     interfaces.forEach((i) => {
       // TODO populate entity if existing
       console.log(i);

       let o = document.createElement('option');
       o.innerText = `${i.node} ${i.name}`;
       o.setAttribute('value', i.interface_id);
       o.dataset.name = i.name;
       o.dataset.node = i.node;
       o.dataset.description = i.description;

       if (!id) {
         id = i.interface_id;
       }
       if (i.interface_id == id) {
         o.setAttribute('selected', true);
       }

       interfaceSelector.appendChild(o);
     });

     interfaceSelector.onchange = this.loadVlans;
     this.loadVlans();
   }
 }
</script>
